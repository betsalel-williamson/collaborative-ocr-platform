services:
  foundationdb:
    image: foundationdb/foundationdb:7.3.69
    container_name: ocr-foundationdb
    environment:
      FDB_NETWORKING_MODE: container
      FDB_COORDINATOR_DESCRIPTION: docker:docker@foundationdb:4500
    volumes:
      - fdb-data:/var/lib/foundationdb/data
      - ./config/foundationdb/fdb.cluster:/etc/foundationdb/fdb.cluster:ro
    ports:
      - "${FDB_EXTERNAL_PORT:-4500}:4500"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "fdbcli --exec 'status' >/dev/null 2>&1 || fdbcli --exec 'configure new single memory' >/dev/null 2>&1",
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  backend:
    build:
      context: ./services/backend
      target: runtime
    depends_on:
      foundationdb:
        condition: service_healthy
      client:
        condition: service_started
    environment:
      BACKEND_PORT: ${BACKEND_PORT:-8080}
      FDB_CLUSTER_FILE: /app/config/fdb.cluster
      CLIENT_BASE_URL: http://client:${CLIENT_PORT:-4173}
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    volumes:
      - ./config/foundationdb/fdb.cluster:/app/config/fdb.cluster:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8080/healthz >/dev/null",
        ]
      interval: 10s
      timeout: 3s
      retries: 6

  client:
    build:
      context: ./services/client
      target: runtime
    environment:
      CLIENT_PORT: ${CLIENT_PORT:-4173}
    command:
      - /bin/sh
      - -c
      - pnpm preview --host 0.0.0.0 --port "${CLIENT_PORT:-4173}"
    ports:
      - "${CLIENT_PORT:-4173}:4173"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://127.0.0.1:${CLIENT_PORT:-4173}/ || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  kestra:
    image: kestra/kestra:latest
    container_name: ocr-kestra
    user: "1000:1000"
    environment:
      KESTRA_CONFIGURATION: /etc/kestra/application.yaml
    volumes:
      - kestra-data:/app/storage
      - ./services/kestra/flows:/app/flows
      # WARNING: Using example secrets file for LOCAL DEVELOPMENT ONLY
      # ‚ùå DO NOT use in staging, production, or any non-locally hosted environments
      # For staging/production, mount a real secrets.yml file from secure storage instead
      - ./config/kestra/application.yaml:/etc/kestra/application.yaml:ro
      - ./config/kestra/secrets.example.yml:/etc/kestra/secrets.yml:ro
    command: ["server", "standalone", "--config", "/etc/kestra/application.yaml"]
    ports:
      - "${KESTRA_UI_PORT:-8081}:8080"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:8080/api/v1/configs || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    depends_on:
      foundationdb:
        condition: service_healthy

volumes:
  fdb-data:
  kestra-data:

